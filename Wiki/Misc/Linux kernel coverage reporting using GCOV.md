---
up: "[[Knowledge Base MoC]]"
related:
  - "[[Android Kernel Driver Fuzzing]]"
tags:
  - "#type/os/linux"
aliases:
  - kernel coverage using gcov
  - kcov vs gcov
status: todo
created-date: 2024-12-15
summary: Generating kernel coverage report using GCOV
---

## Build instruction

Below are steps to utilize GCOV for coverage recording on kernel.

1. Set Up and Build GCOV Kernel Image**
	
	To make this work on your driver, you will need to configurate build set up for your local image. To manually set it up, you will need below lines in your build configuration:
	```bash
	CONFIG_DEBUG_FS=y
	CONFIG_GCOV_KERNEL=y
	```
	To turn on GCOV recording on the entire kernel, you will also need:
	
	`CONFIG_GCOV_PROFILE_ALL=y`
	
	Luckily, our kernel image supports Bazel build system, so by passing below argument to Bazel will trigger above three configurations. _Note instrumenting the entire kernel will exhaust the memory limitation on device._
	
	`export EXTRA_KBUILD_ARGS=--gcov`
	
	To only instrument your driver, configure it individually within its build config.
	
	`GCOV_PROFILE := y`
	
	Then build and flush the image as normal.

1. **Step 1. Retrieve GCOV Recording From Device**
	Once the device boots up, you will find all GCOV recordings within below folder.
	
	`/sys/kernel/debug/gcov/`
	
	The recording files have an extention of _*.gcda_. You will need to retrieve all _gcda_ files from the device to your host for future processing.

1. **Step 2. Generate Coverage Visualization**
	On your local Linux host, you will need the most current LCOV at least 2.x above and Perl5 above 5.26.x to proceed.
	
	First, extract coverage trace from all recordings. Assuming all coverage recording _gcda_ files and all _gcno_ base files generated by compiler are in ./_cov_/ folder.
	
	`lcov -c -d ./cov/ -o cov.info`
	
	Then generate the HTML visualization based on the extracted trace.
	
	`genhtml cov.info -o ./out/ --legend -s`
	
	Now, you can find the HTML files within the *./out* folder.	
	Currently, devices cannot boot up with a full instrumentation on the entire kernel using GCOV because of the memory restriction, however this should not be a limitation to generate coverage on individual drivers. Biswajit and I will work with respective teams to enable this on the entire kernel so we will have an universal image. I will follow up this thread once that happens.

	This method involves several experimental features from the compiler.


## KCOV vs GCOV

1. KCOV advantage : read the coverage of the fuzzing task context exclusively (without counting the coverage caused by other daemons in the kernel that may also invoke functions in fuzzing scope.
2. Coverage reporting : GCOV help better visualize the coverage when we’re trying to fix up harnesses and generate reports.
	1. KCov, for speed, has the limitation that it has limited injection points for coverage feedback which can make it difficult to parse mentally when we’re looking through the report. For example we were looking at one of her drivers where she had coverage data that was confusing *due to the compiler optimizing away a switch statement*, which lead to KCov reporting misleading information in the report.
	2. GCov injects significantly more coverage callbacks which allows us to see the coverage in a more realistic way.
3. GCOV as developing tools when we need to improve the coverage. We can have both(KCOV & GCOV) together (and maybe other coverage reporting tools) as long as they help us better understand which lines are not covered and why.
4. For the process awareness during fuzzing, two cases:
	1. Other processes are adding more coverage to the fuzzing coverage, and we only want the coverage triggered by fuzzing but not others.
		1. we can have a baseline file before fuzzing starts to eliminate the add up, LCOV 2.x+ supports this feature.
	2. Processes interacting with the main process are not recorded.
		1. we can manually dump the coverage from processes we care using *__gov_dump()*


## Ref Notes

- When Build machine and test machine are different you need

## Ref

- [Linux kernel doc on gcov](https://www.kernel.org/doc/html/v4.16/dev-tools/gcov.html)