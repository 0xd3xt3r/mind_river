---
tags:
  - qpsi/project
  - uefi
  - firmware-security
  - variant-analysis
  - "#type/sub-project"
status: done
created-date: 2022-11-15
up: "[[WoS Kernel Driver Fuzzing]]"
summary: UEFI Vulnerability Detection effort
---

## Intro

- [[UEFI]] is a the new booting standard which replaces [[BIOS]]
- it implements lots of things which BIOS does but in a standardized manner which is consistent across different vendors
- There are UEFI runs in parallel with systems primary OS and user can crate service application which a sort of like driver in kernel

## Notes

- [[Inbox/Klockwork]] pattern 
	- [How to run klockwork in desktop](https://confluence.qualcomm.com/confluence/display/QPSIRoadMapTeam/Klocwork+Setup)
	- [KW Docs](https://help.klocwork.com/current/en-us/concepts/ccknowledgebasereference.htm)
	- Tainted and unsafe data records - The tainted data records relate to functions that may return or use un-validated data. The tainted data records are:
		-   **TaintedIntData** specifies a function that returns an integer
		-   **UnsafeAllocSizeAccepter** specifies a function that uses data for memory allocation size

### Docs

#### Syncing and Building

```bash
cd /local/mnt/workspace/  
export PATH=/pkg/qct/software/ubuntu/python/3.8.2/bin:$PATH;  
export PATH=$PATH:/pkg/qct/software/perforce/bin  
export PATH=/pkg/qct/software/ubuntu/python/2.7.12/bin:$PATH;  
export P4PORT=qctp401:1666  
p4 login  

# syncing  
python2 /prj/qct/asw/qctss/linux/bin/vce/vce.py view --base core.boot.5.0.1 --image 90641 --checkout kod_11_14  
python2 /prj/qct/asw/qctss/linux/bin/vce/vce.py view --base core.boot.5.1 --checkout mak_7_25  --image 83912

# build
python -u boot_images/boot_tools/buildex.py -v LAA -t Kodiak -r DEBUG
```

## Attack surface

- GetVariable - is data is stored in NVRAM and its also an way to interact between OS kernel and UEFI services
- BIOS updates via the so-called Capsule Update handed to the UEFI firmware.


## Bug Reports

|Bug ID | CR| Status|
|---|---|---|
| 1 | https://orbit/CR/3337067 | This was request for withdrawal instead raised CR ID 7 & 8 as shown below|
| 2 | https://orbit/CR/3337072 | Withdrawn, bug not reachable |
| 3 | https://orbit/CR/3337075 | Withdrawn, bug not reachable |
| 4 | https://orbit/CR/3337098 | Get/SetVariable Bugs |
| 5 | https://orbit/CR/3337088 | Get/SetVariable Bugs |
| 6 | https://orbit/CR/3337104 | Get/SetVariable Bugs |
| 7 | https://orbit/CR/3386478 | ELF Header parsing replaced 3337067 |
| 8 | https://orbit/CR/3386483 | ELF Header parsing replaced 3337067 |
| 9 | https://orbit/CR/3453941 | Linux kernel MDT loader bug |

### Bug 1

- Bug in UpdateDsdtTable function
- **gRT->GetVariable** is call twice at line 621 and 629 and **VarSize** is not reset
- [code link](https://corebsp-grok-server.qualcomm.com/source/xref/BOOT.MXF.2.0-00905-WAIPIO-1.17794.4/boot/QcomPkg/Drivers/WinAcpiUpdate/WinAcpiUpdate.c#629)

### Bug 2

- Bug is in GetDefectiveParts(VOID) function
- if the "GetVariable" returns error [link](https://corebsp-grok-server.qualcomm.com/source/xref/BOOT.MXF.2.0-00905-WAIPIO-1.17794.4/boot/QcomPkg/Drivers/WinAcpiUpdate/WinAcpiUpdate.c#850)
- the "SetVariable" function is call and the "VarSize" is not reset.
- the only error checking which is done is at line 851 which just check if it succeeds or not, It doesn't check what kind of vulnerability it is.
- https://corebsp-grok-server.qualcomm.com/source/xref/BOOT.MXF.2.0-00905-WAIPIO-1.17794.4/boot/QcomPkg/QcomTestPkg/UefiSim/UefiSim.h#54
- ~~*Not bug** its not overflowing any buffer with new "VarSize" its just overwrite new variable with "SetVaraiable"~~
- a potential attacker can write `X - 4` bytes from the stack to NVRAM if writes any buffer of length `X > 4` to the `BSPowerCycles` NVRAM variable.

### Bug 3

- The bug is in GetDefectiveCPUs(VOID) function
- if the code flows till [GetVariable](https://corebsp-grok-server.qualcomm.com/source/xref/BOOT.MXF.2.0-00905-WAIPIO-1.17794.4/boot/QcomPkg/Drivers/WinAcpiUpdate/WinAcpiUpdate.c#924) this can overwrite "VarSize"
- this code then progress to [link](https://corebsp-grok-server.qualcomm.com/source/xref/BOOT.MXF.2.0-00905-WAIPIO-1.17794.4/boot/QcomPkg/Drivers/WinAcpiUpdate/WinAcpiUpdate.c#949) it overwrite the the data.
- ~~**Not bug** its not overflowing any buffer with new "VarSize" its just overwrite new variable with "SetVaraiable"~~
- a potential attacker can write `X - 4` bytes from the stack to NVRAM if writes any buffer of length `X > 4` to the `BSPowerCycles` NVRAM variable.
