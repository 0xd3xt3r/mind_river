---
tags:
  - "#type/os/linux"
status:
  - todo
created-date: 2024-12-15
up: "[[Knowledge Base MoC]]"
related: 
summary: All the resources related to kernel exploitation
---

Tags: #exploitation, #kernel, #linux-kernel, #pwn


## Setup Lab Environment

1. This [article](https://www.josehu.com/memo/2021/01/02/linux-kernel-build-debug.html) on **Linux Kernel Debug Build**  show how to build and run the kernel on [[Inbox/Qemu]].
	1. It also specifies instruction to build minimum file system using buildroot and how to setup ssh server in the emulator so that you can send files in and out of the system.
	2. It also show how to setup kernel debugging with Qemu and [GDB](https://www.kernel.org/doc/html/latest/dev-tools/gdb-kernel-debugging.html).
2. Another important tool for debugging kernel is [Event Tracing](https://www.kernel.org/doc/html/latest/trace/events.html)
	1. If the event tracing is enabled **/sys/kernel/debug** directory is populated with data. if you can't find the directory then you can mount it with this command `mount -t debugfs none /sys/kernel/debug`
3. [Debug Ubuntu Kernel with GDB & Qemu](https://mhcerri.github.io/posts/debugging-the-ubuntu-kernel-with-gdb-and-qemu/)

## Notes
- [Android ION Buffer](https://lwn.net/Articles/480055/)
- [Attacking QCOM Truztzone](https://tamirzb.com/attacking-android-kernel-using-qualcomm-trustzone)
	- https://www.zimperium.com/blog/multiple-kernel-vulnerabilities-affecting-all-qualcomm-devices/

## Public Bug Hunting

- https://bugs.chromium.org/p/project-zero/issues/detail?id=2390
- [Linux Bugs reported to Google Project Zero](https://bugs.chromium.org/p/project-zero/issues/list?q=label%3AVendor-Linux&can=1&sort=-reported&colspec=ID%20Status%20Reported%20Product%20Summary%20Severity)

### Public Instances

- [Elisa builder](https://elisa-builder-00.iol.unh.edu/syzkaller/)
	- io uring
		- https://elisa-builder-00.iol.unh.edu/syzkaller/crash?id=f9c3b16b3bb5b3425e6b4f9b13dafee726b3ca70
		- https://elisa-builder-00.iol.unh.edu/syzkaller/crash?id=7a7ff2382fdfd8e5522f356d2c345e4b739d9448
		- https://elisa-builder-00.iol.unh.edu/syzkaller/crash?id=97b6b8ec9b974d3be26f374d749ac22af3eb0ddd
		- https://elisa-builder-00.iol.unh.edu/syzkaller/crash?id=959057ecd2886ff0c38cc53fa9c8eae46c1d7496
- [Google Syzkaller Public Instance](https://syzkaller.appspot.com)
	- https://syzkaller.appspot.com/bug?id=28c4a71ecc4b55c2bbc7d921f0972df1a1a701b9

## Exploitation Primitives

- The goal of kernel exploit gain root privilege to the system that can be done by using two functions `commit_creds()` and `prepare_kernel_cred()` we can this two function in following manner `commit_creds(prepare_kernel_cred(0))`
- Heap grooming - very good lecture can be found [here](https://www.youtube.com/watch?v=pFi-JKgoX-I&ab_channel=JamesShacklefordhttps://www.youtube.com/watch?v=pFi-JKgoX-I&ab_channel=JamesShackleford) also [here](https://www.youtube.com/watch?v=5-eRsA0l8Pg&ab_channel=VitalyNikolenkohttps://www.youtube.com/watch?v=5-eRsA0l8Pg&ab_channel=VitalyNikolenko)

## Kernel Exploit Mitigation

-   [Kernel stack cookies (or canaries)](http://www.phrack.org/issues/49/14.html#article) - this is exactly the same as stack canaries on userland. It is enabled in the kernel at compile time and cannot be disabled.
-   [Kernel address space layout randomization (KASLR)](https://lwn.net/Articles/569635/) - also like `ASLR` on userland, it randomizes the base address where the kernel is loaded each time the system is booted. It can be enabled/disabled by adding `kaslr` or `nokaslr` under `-append` option.
-   [Supervisor mode execution protection (SMEP)](https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf) - this feature marks all the userland pages in the page table as non-executable when the process is in kernel-mode. In the kernel, this is enabled by setting the `20th bit` of Control Register `CR4`. On boot, it can be enabled by adding `+smep` to `-cpu`, and disabled by adding `nosmep` to `-append`.
-   [Supervisor Mode Access Prevention (SMAP)](https://lwn.net/Articles/517475/) - complementing `SMEP`, this feature marks all the userland pages in the page table as non-accessible when the process is in kernel-mode, which means they cannot be read or written as well. In the kernel, this is enabled by setting the `21st bit` of Control Register `CR4`. On boot, it can be enabled by adding `+smap` to `-cpu`, and disabled by adding `nosmap` to `-append`.
-   [Kernel page-table isolation (KPTI)](https://lwn.net/Articles/741878/) - when this feature is active, the kernel separates user-space and kernel-space page tables entirely, instead of using just one set of page tables that contains both user-space and kernel-space addresses. One set of page tables includes both kernel-space and user-space addresses same as before, but it is only used when the system is running in kernel mode. The second set of page tables for use in user mode contains a copy of user-space and a _minimal set of kernel-space addresses_. It can be enabled/disabled by adding `kpti=1` or `nopti` under `-append` option.

## Fuzzing

There two major ways you fuzz the kernel device drivers.
1. First using [[Inbox/Qemu]] device driver plugin. In this technique you write qemu device plugin and running the OS in the qemu and your plugin will inject the data form the firmware side i.e. the kernel to peripheral interface.
2. writing the device kernel to user and vice-versa interface where you have your custom driver code in the kernel which intercepts and inject command to the driver you want to fuzz. this approach is very similar to kernel [[network stack fuzzing]] and [[usb fuzzing]]. 

## Attack Techniques 

### Heap Spray

1. sendmsg/signalfd
	1. https://labs.bluefrostsecurity.de/blog/2020/04/08/cve-2020-0041-part-2-escalating-to-root/

### Kernel Space Mirroring Attack

https://medium.com/hackernoon/entering-god-mode-the-kernel-space-mirroring-attack-8a86b749545f

## Case Studies

### Project Zero Bug

- [Bug Link](https://bugs.chromium.org/p/project-zero/issues/detail?id=2390)
- This bug is in this use-case of camera driver [link](https://www.kernel.org/doc/html/v4.9/media/uapi/v4l/userp.html) which basically allows sending video frame capture data to the Userspace application. The Userspace application allocates buffer and passes the user buffer pointer and its length to video device via ioctl call. This is done via VIDIOC_REQBUFS
- This bug arises when the video driver starts writing video frame data to the user buffer and the driver doesn't do any check done on the permission of the page backing the user buffer and it writes to it even if the page is read only. This is done via VIDIOC_QBUF ioctl call.
- when the VIDIOC_REQBUFS call is done the kernel lock the page in memory so that it doesn't get swapped out. If the userspace does munmap still the kernel will hold on that page reference causing [[UAF]] and if the page get remapped by some other mmap request it will write data to that page even if it is written by some other usecase in the same process.
- The bug report has poc code for both the way of exploiting which is discussed above

### CVE-2017-11176

Bug : [[UAF]]

#### Notes
 - the blog series by lexfo explain in detail about the how to exploit linux UAF in extreme detail

- [[io_uring sub-systems]]

### [[eBPF]] sub-system Vulnerability
- BPF is a highly flexible and efficient virtual machine-like construct in the Linux kernel allowing to execute bytecode at various hook points in a safe manner. It is used in a number of Linux kernel subsystems, most prominently networking, tracing and security (e.g. sandboxing).
- [This Reference Guide](https://docs.cilium.io/en/stable/bpf/) is an excellent resource to understand [[eBPF]] architecture and it also has [instruction to compile](https://docs.cilium.io/en/stable/bpf/) it with [Linux kernel].
- https://blog.trailofbits.com/2023/01/19/ebpf-verifier-harness/
#### Setup
- `bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h`

### Page overwrite
- [Dirty Cow and Dirty Pipe](https://0x434b.dev/learning-linux-kernel-exploitation-part-2-cve-2022-0847/)

### References
- https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html
- https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part2.html
- https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html
- https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part4.html
- https://a13xp0p0v.github.io/2021/02/09/CVE-2021-26708.html

## Github Projects

1. [kernel-hacking](https://github.com/AravGarg/kernel-hacking)
2. [kernel-security-learning](https://github.com/bsauce/kernel-security-learning)
3. [learning-linux-kernel](https://github.com/danbev/learning-linux-kernel)
4. [Kernel Heap debugging](https://github.com/PaoloMonti42/salt/)


## Reading Material

- [How2Kernel](https://github.com/R3x/How2Kernel/tree/master/Lab1) 
- [SLUB Allocator](http://jake.dothome.co.kr/slub/)  
- [csaw-ctf-kernel-exploitation-challenge](https://jon.oberheide.org/blog/2010/11/02/csaw-ctf-kernel-exploitation-challenge/)  
- [csaw-ctf-2011-kernel-exploitation-challenge/](https://jon.oberheide.org/blog/2011/11/27/csaw-ctf-2011-kernel-exploitation-challenge/)  
- [NCSTISC Linux Kernel pwn450 writeup.html](https://whereisk0shl.top/NCSTISC%20Linux%20Kernel%20pwn450%20writeup.html)  
- [linux-kernel-rop-ropping-your-way-to-part-1/](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/linux-kernel-rop-ropping-your-way-to-part-1/)  
- [linux-kernel-rop-ropping-your-way-to-part-2/](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/linux-kernel-rop-ropping-your-way-to-part-2/)  
- [TEC/03.Linux+Kernel+Exploitation+Tutorial](https://www.lazenca.net/display/TEC/03.Linux+Kernel+Exploitation+Tutorial)  
- [cve-2017-11176 linux-kernel-exploitation](https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html)
- https://argp.github.io/2012/01/03/linux-kernel-heap-exploitation/
- UNCONTAINED: Uncovering Container Confusion in the Linux Kernel - new vulnerability class in linux kernel because of [[container_of]]

## Practice

- [https://github.com/R3x/How2Kernel](https://github.com/R3x/How2Kernel)  
- [https://github.com/RPISEC/MBE/tree/master/src/lab10](https://github.com/RPISEC/MBE/tree/master/src/lab10)  
- [https://github.com/xairy/linux-kernel-exploitation#ctf-tasks](https://github.com/xairy/linux-kernel-exploitation#ctf-tasks)  
- [https://github.com/pr0cf5/kernel-exploit-practice](https://github.com/pr0cf5/kernel-exploit-practice)  
- [https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/kernel\_uaf/](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/kernel_uaf/)  
- 

## References

1. https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1
2. https://lkmidas.github.io/posts/20210128-linux-kernel-pwn-part-2/
3. https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/
4. www.bricktou.com - site for good kernel notes and annotation by users.
5. https://www.linuxkernelcves.com/cves
6. https://github.com/nluedtke/linux_kernel_cves/
7. https://a13xp0p0v.github.io/2021/02/09/CVE-2021-26708.html
8. https://github.com/xairy/linux-kernel-exploitation
