---
tags:
  - "#vulnerability-research"
  - "#windows-patch"
  - "#type/project/personal"
up: "[[Personal Project MoC]]"
created-date: 2024-12-21
status: done
---

> **Summary**:: Detail analysis of windows HTTP vulnerability using patch diffing.

## Vulnerability Details

- CVE-2023-23392	
- HTTP Remote Vulnerability https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-23392
- Vulnerability is in windows server http stack which attacker can remotely compromise

![[Pasted image 20230416141247.png]]

I focused on following version
![[Pasted image 20230416141314.png]]

- Obtain binary from [link](https://winbindex.m417z.com/) for http.sys
- ![[Pasted image 20230416141654.png]]
- We choose to diff the patched version **10.0.22621.1413** as per the vulnerability page and the previous version **10.0.22621.1344**

## Mitigation

Mitigation refers to a setting, common configuration, or general best-practice, existing in a default state, that could reduce the severity of exploitation of a vulnerability. The following mitigating factors might be helpful in your situation:

A prerequisite for a server to be vulnerable is that the binding has HTTP/3 enabled and the server uses buffered I/O. HTTP/3 support for services is a new feature of Windows Server 2022. Currently, enabling HTTP/3 is done via a registry key as discussed in this article: [Enabling HTTP/3 support on Windows Server 2022](https://techcommunity.microsoft.com/t5/networking-blog/enabling-http-3-support-on-windows-server-2022/ba-p/2676880)

- Diff between **10.0.22621.1485** and **10.0.22000.1761**

## Patch Diff

![[Pasted image 20230416150108.png]]

Vulnerable binary function
![[Pasted image 20230416145958.png]]

Patched Binary Function
![[Pasted image 20230416145930.png]]

![[Pasted image 20230418162449.png]]


## CVE 2023-23410

### Notes
- Existing research
	- https://github.com/SapDragon/http.sys-research
	- https://www.numencyber.com/cve-2023-23410-analysis/
	- https://learn.microsoft.com/en-us/windows/win32/api/http/nf-http-httpseturlgroupproperty
	- https://github.com/microsoft/Windows-classic-samples/blob/main/Samples/Win7Samples/netds/http/httpauth/main.c
- Code Path
	- UlCaptureChannelBindConfig - vulnerable function
	- UlSetServerSessionProperty
	- UlSetServerSessionIoctl - entry point that we can trigger

```bash
 Refreshing KD connection

*** Fatal System Error: 0x00000050
                       (0xFFFFDC8202376000,0x0000000000000001,0xFFFFF800D5B3179C,0x0000000000000000)

Driver at fault: 
***      HTTP.sys - Address FFFFF800D5B3179C base at FFFFF800D5B30000, DateStamp 318e4646
.
Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

For analysis of this file, run !analyze -v
nt!DbgBreakPoint:
fffff802`87408830 d43e0000 brk         #0xF000
2: kd> g

 QdssConfigUploadRpeCB - ClientInfo ~ 0000337B0FD50FF8 : MemoryRegionIndex ~ 0 : pMemoryRegion ~ FFFFED889CF300F0

QdssStoreConfig entry -  pDeviceContext ~ FFFFCC84F02AF330 pCrashBuffer ~ FFFFDC8200C7E000

[Qdss CRASH CODE] QdssUploadRpeConfig - MemoryRegionIndex ~ 0 : pMemoryRegion ~ FFFFED889CF300F0
Subsystem Type = 3 : New Smp2pRead returned Ack = 'No', ErrFatal = 'No' (data: 0x6) 
Subsystem Type = 3 : New Smp2pRead returned Ack = 'No', ErrFatal = 'No' (data: 0x106) 
Subsystem Type = 3 : New Smp2pRead returned Ack = 'Yes', ErrFatal = 'No' (data: 0x10e) 
Subsystem Type = 4 : New Smp2pRead returned Ack = 'No', ErrFatal = 'No' (data: 0x6) 
Subsystem Type = 4 : New Smp2pRead returned Ack = 'No', ErrFatal = 'No' (data: 0x106) 
Subsystem Type = 4 : New Smp2pRead returned Ack = 'Yes', ErrFatal = 'No' (data: 0x10e) 
Subsystem Type = 1 : New Smp2pRead returned Ack = 'No', ErrFatal = 'No' (data: 0x6) 
Subsystem Type = 1 : New Smp2pRead returned Ack = 'No', ErrFatal = 'No' (data: 0x106) 
Subsystem Type = 1 : New Smp2pRead returned Ack = 'Yes', ErrFatal = 'No' (data: 0x10e) 

```
## Ref
- related [link](https://nsfocusglobal.com/http-stack-remote-code-execution-vulnerability-cve-2022-21907-alert/)
- Inspiration [link](https://securityintelligence.com/posts/patch-tuesday-exploit-wednesday-pwning-windows-ancillary-function-driver-winsock/)
- https://cve-north-stars.github.io/docs/Security-Patches
- https://github.com/SapDragon/http.sys-research
- https://gist.github.com/worawit/54f2e5a7a1a028191f76