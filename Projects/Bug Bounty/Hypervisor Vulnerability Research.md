---
tags:
  - vulnerability-research
  - hypervisor
status: in-progress
created-date: 26-03-2021
---

# Intel VT-x

## Paging

1. Second Level Address Translation (SLAT)
2. Software-assisted paging (Shadow Page Tables)
	1. The hypervisor uses Shadow Page Tables to keep track of the state of physical memory in which the guest thinks that it has access to physical memory, but in the real world, the hardware prevents it from accessing hardware memory.
	2. Without this prevention, the guest might control the host, which is not what is intended.
	3. In this case, VMM maintains Shadow Page Tables that map guest virtual pages directly to machine pages.
	4. ![[Pasted image 20230625150040.png]]
3. Extended Page Table EPT
	- One page table is maintained by guest OS, which is used to generate the guest’s physical address.
	- The other page table is maintained by VMM, which maps the guest’s physical address to the host’s physical address.

## hardware-assisted-paging-extended-page-table

1. [Hypervisor development](https://revers.engineering/7-days-to-virtualization-a-series-on-hypervisor-development/)
2. [Intel Extended Page Table Series](https://revers.engineering/mmu-virtualization-via-intel-ept-index/)
3. [VT-x page table](https://rayanfam.com/topics/hypervisor-from-scratch-part-4/#hardware-assisted-paging-extended-page-table)

## Android Hypervisor

1. [pKVM](https://source.android.com/docs/core/virtualization/pkvm-modules) is android adaptation of virtualization in android you can find more info on architecture on this [link](https://source.android.com/docs/core/virtualization/architecture)

## VirtualBox

- hmR0VmxPostRunGuest
- hmR0VmxRunGuestCodeNormal
- hmR0VmxRunGuestCodeNested
- hmR0VmxRunGuestCodeDebug
- VMXR0RunGuestCode
- g_HmR0OpsVmx


## Ref
1. [Linux Source tools](https://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git/tree/README)
2. [KVM tutorial](https://lwn.net/Articles/658511/)
3. https://zserge.com/posts/kvm/

# Vulnerability Research

## Threat Model

1. Host User to Host Kernel Driver communication
2. Device Emulation (VM Escape)
3. Guest Kernel <--> Host Kernel VMM communication (VM Escape)


## Public Research

1. [Hack Out Of The Box: Discovering 10+ Vulnerabilities In VirtualBox - Chen Nan](https://www.youtube.com/watch?v=_4kttxArxuk&ab_channel=HackInTheBoxSecurityConference)
	1. Good overview of source code structure
	3. General Communication
		1. ![[Pasted image 20240512164011.png]]
		2. Emulates communication of general computer devices
		3. Emulation of Devices - guest does not require vbox drivers.
		4. General Communication Method
			1. IO instruction - IN, OUT, REP IN, REP OUT
				1. used to exchange physical memory address between Guest and Host VM
			2. MMIO or DMA : mov instruction
				1. Setup a shared buffer between Guest and Host
			3. Special Instruction : CPUID, INT, MSR, HyperCall, etc,
				1. this doesn't involves parsing of complex parsing of buffer and just mimics the behaviour of the CPU
			4. All this is run in Guest Kernel (Ring 0)
			5. Emulated Devices List:
				1. Emulate motherboard chipset
				2. VGA Devices
				3. Network Devices (E1000)
				4. Audio Controller (HDA, SB16, ICHAC97)
				5. USB Controller (OHCI, EHCI, XHCI)
				6. Storage Controller(AHCI, FDC, SCSI, )
				7. Serial Port Device
				8. Refer to the data Sheets of these Controller to understand their programming model. That how you learn about emulated devices
	5. Special Communication
		1. ![[Pasted image 20240512163931.png]]
		2. This type of communication requires Special Drivers in the Guest OS.(vbox drivers)
			1. Some of the sample drivers are VBoxGuest VBoxStorage, VBoxVideo, etc.
		3. Custom Communication Protocol - these are custom protocol different for each vendor
			1. VBox protocol - HGSMI, HGCM, FIFO
			2. They used same Port IO, MMIO method to share data.
		4. Used for Service Discovery of Virtual Machine
		5. Also used to special features like folder sharing, drag and drop, etc.
		6. Also used in BIOS
		7. Special Devices are Virtio Ethernet Device, Virtio SCSI, Virtual KD, VBVA, SVGA/3D, VMM, GIM, etc.
		8. VMM device provide basic protocols HGCM for various services. for folder sharing, drag and drop.
	6. Backend Communication
		1. ![[Pasted image 20240512165311.png]]
		2. Component called by the device to implement specific functions. Usually it depends on the host OS and physical devices.
		3. The communication between the device and the backend usually has an intermediate driver component, which is an important attack surface.
		4. USB Backend ![[Pasted image 20240512165448.png]]
		5. Storage Backend ![[Pasted image 20240512165536.png]]
		6. VMM Backend ![[Pasted image 20240512165701.png]]
		7. SVGA3D Backend ![[Pasted image 20240512165746.png]]

## Source Code Overview

1. Device Construction
	1. This structure contain the information about the device along with the lifecycle method (callback function) of the device.
	2. `struct PDMDEVREG` for eg `const PDMDEVREG g_DeviceE1000`
		1. pfnContruct - device constructor
		2. pfnPowerOn - startup function
	3. Unified device interface defined by virtual box
	4. this structure is used to initialise emulated device
3. instruction handler like in/out, mov
	1. FNIOMMMIOWRITE, FNIOMMMIONEWWRITE